<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>CSS 3的animate动画演示</title>
    <style>
        #content { position: relative; width: 900px; padding-top: 300px; margin: 0 auto; }
    </style>
</head>
<body>
    <div id="content">
        <style>
            .demo { background-color: #0094ff; width: 100px; height: 100px; position: absolute; left: 0; color: #fff; text-align: center; line-height: 100px; }
        </style>
        <div class="demo" id="demo" style="left:0;">点击这里</div>
        <script>
            (function (window) {
                var Support = {
                    cssPrefix: null,
                    eventPrefix: null,
                    onTransitionEnd: null
                },
                testElem = document.createElement('div'),
                //transitionProperty、webkitTransitionProperty、MozTransitionDuration、TODO 尚未验证、msTransitionProperty
                vendors = { '': '', 'Webkit': 'webkit', 'Moz': '', 'O': 'o', 'ms': 'ms' },
                /*
                    https://github.com/madrobby/zepto/pull/742
                    firefox从未支持过mozTransitionEnd或MozTransitionEnd，firefox一直支持标准的事件transitionend
                */
                normalizeEvent = function (name) {
                    return Support.eventPrefix ? Support.eventPrefix + name : name.toLowerCase();
                };
                Object.keys(vendors).some(function (name) {
                    var eventPrefix = vendors[name];
                    //嗅探特性
                    if (testElem.style[(name ? name + 'T' : 't') + 'ransitionProperty'] !== undefined) {
                        Support.cssPrefix = name ? '-' + name.toLowerCase() + '-' : name;
                        Support.eventPrefix = eventPrefix;
                        Support.onTransitionEnd = normalizeEvent('TransitionEnd');
                        return true;
                    }
                })
                //动画结束事件
                var onTransitionEnd = Support.onTransitionEnd !== null ?
                    //animationEnd从android 4.1支持
                     function (el, callback, time) {
                         //支持transition
                         var onEndCallbackFn = function (e) {
                             if (typeof e !== 'undefined') {
                                 if (e.target !== e.currentTarget) return;//防止冒泡
                             }
                             this.removeEventListener(Support.onTransitionEnd, onEndCallbackFn);
                             callback.call(el);
                         };
                         el.addEventListener(Support.onTransitionEnd, onEndCallbackFn);
                     } : function (el, callback, time) {
                         //不支持
                         setTimeout(function () {
                             callback.call(el);
                         }, time);
                     };
                if (Support.cssPrefix == null) {
                    Support.cssPrefix = '';
                    Support.eventPrefix = '';
                }

                //动画
                var animatePrototypes = {
                    transitionProperty: Support.cssPrefix + 'transition-property',
                    transitionDuration: Support.cssPrefix + 'transition-duration',
                    transitionDelay: Support.cssPrefix + 'transition-delay',
                    transitionTiming: Support.cssPrefix + 'transition-timing-function'
                };

                /**
                * 动画
                * animate(elem, properties, duration)
                * animate(elem, properties, duration, ease)
                * animate(elem, properties, duration, callback, delay)
                * animate(elem, properties, duration, ease, callback, delay)
                * @param {int} elem - 要执行动画的元素
                * @param {function|string} properties - 动画执行的目标属性，为String则表示是animation-name，为object则是transition-property
                * @param {int} duration - 动画执行时间(ms)
                * @param {string} [ease = linear] - 动画线性
                * @param {function} [callback = null] - 动画执行完成的回调函数
                * @param {int} [delay = 0] - 动画延迟(s)
                * @returns {Service}
                */
                var animate = function (elem, properties, duration, ease, callback, delay) {
                    //各种修正参数支持重载
                    if (typeof ease === 'function') {
                        //重载
                        delay = callback;
                        callback = ease;
                        ease = null;
                    }
                    var cssProperties = [],
                        cssValues = {},
                        transformValues = '',
                        eventCallback,
                        cssStr = [],
                        value;
                    Object.keys(properties).forEach(function (name) {
                        value = properties[name];
                        cssValues[name] = typeof value === 'number' ? value + 'px' : value;
                        cssProperties.push(name);
                    })
                    cssValues[animatePrototypes.transitionProperty] = cssProperties.join(', ');
                    cssValues[animatePrototypes.transitionDuration] = duration + 's';
                    cssValues[animatePrototypes.transitionDelay] = (delay || 0) + 's';
                    cssValues[animatePrototypes.transitionTiming] = (ease || 'linear');

                    if (callback) {
                        onTransitionEnd(elem, callback, duration);
                    }
                    //设置样式
                    for (var key in cssValues) {
                        cssStr.push(key + ':' + cssValues[key]);
                    }

                    //聪明的同学，想想为什么？
                    setTimeout(function () {
                        elem.style.cssText += ';' + cssStr.join(';');
                    }, 0);
                };

                window.animate = animate;
            })(window);
        </script>
        <script>
            //var elem = document.getElementById('demo')
            //elem.onclick = function () {
            //    var left = parseInt(this.style.left);
            //    if (left > 0)
            //        animate(this, { left: 0 }, 1, 'ease-in-out', function () {
            //            alert('向左结束');
            //        });
            //    else
            //        animate(this, { left: 200 }, 1, 'ease-in-out', function () {
            //            alert('向右结束');
            //        });
            //};

            var elem = document.getElementById('demo'),//获取元素
                elemStyleSheet = elem.style,//元素的内联样式对象
                left = parseInt(elemStyleSheet.left),//获取当前left
                targetLeft = 200,//目标left
                time = 13,//动画每帧间隔
                offsetValue = targetLeft / parseInt(1000 / 13),//每帧偏移量
                intervalId,
                temp;//临时变量
            
            elem.onclick = function () {
                intervalId = setInterval(function () {
                    //追加偏移量
                    temp = parseInt(elemStyleSheet.left) + offsetValue;
                    elemStyleSheet.left = temp + 'px';

                    if (temp >= targetLeft)//完成动画
                        clearInterval(intervalId);
                }, time);
            };

        </script>

        <script>


        </script>
    </div>
</body>
</html>
